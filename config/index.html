<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis ROMs</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #1a1a2e; color: #eee; min-height: 100vh; }
        .header { background: linear-gradient(135deg, #16213e 0%, #1a1a2e 100%); padding: 25px; text-align: center; border-bottom: 2px solid #e94560; }
        .header h1 { color: #e94560; font-size: 2.5em; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .consoles { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .console-btn { background: linear-gradient(145deg, #0f3460, #16213e); border: 2px solid #0f3460; padding: 40px 20px; border-radius: 15px; cursor: pointer; transition: all 0.3s; text-align: center; }
        .console-btn:hover { background: linear-gradient(145deg, #e94560, #c73e54); border-color: #e94560; transform: translateY(-5px); box-shadow: 0 10px 30px rgba(233, 69, 96, 0.3); }
        .console-btn h2 { color: #fff; margin-bottom: 10px; font-size: 1.4em; }
        .console-btn span { color: #aaa; font-size: 1.1em; display: block; }
        .console-btn:hover span { color: #fff; }
        .console-btn .download-pack { margin-top: 15px; background: rgba(0,0,0,0.3); color: #4ade80; border: 1px solid #4ade80; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.85em; transition: all 0.3s; }
        .console-btn .download-pack:hover { background: #4ade80; color: #000; }
        .games { display: none; }
        .games.active { display: block; }
        .games-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; max-height: 70vh; overflow-y: auto; padding: 10px; }
        .game-card { background: linear-gradient(145deg, #0f3460, #16213e); border-radius: 12px; transition: all 0.3s; overflow: hidden; border: 2px solid transparent; }
        .game-card:hover { transform: translateY(-5px); border-color: #e94560; box-shadow: 0 10px 25px rgba(233, 69, 96, 0.3); }
        .game-cover { width: 100%; height: 180px; background: #16213e; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .game-cover .no-cover { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); padding: 15px; text-align: center; }
        .game-cover .no-cover .icon { font-size: 50px; margin-bottom: 10px; }
        .game-cover .no-cover .name { font-size: 11px; color: #888; word-break: break-word; }
        .game-info { padding: 10px; background: rgba(0,0,0,0.3); }
        .game-title { text-align: center; font-size: 0.8em; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 8px; cursor: pointer; }
        .game-title:hover { color: #e94560; }
        .game-actions { display: flex; gap: 5px; justify-content: center; }
        .btn-play, .btn-download { flex: 1; padding: 8px 5px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.75em; transition: all 0.2s; }
        .btn-play { background: #e94560; color: #fff; }
        .btn-play:hover { background: #ff6b8a; transform: scale(1.05); }
        .btn-download { background: #4ade80; color: #000; }
        .btn-download:hover { background: #6ee7a0; transform: scale(1.05); }
        .back-btn { background: linear-gradient(145deg, #e94560, #c73e54); color: #fff; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 16px; transition: all 0.3s; }
        .download-all-btn { background: linear-gradient(145deg, #4ade80, #22c55e); color: #000; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; }
        .search { width: 100%; padding: 15px 20px; margin-bottom: 20px; border-radius: 10px; border: 2px solid #0f3460; font-size: 16px; background: #16213e; color: #fff; }
        .search:focus { outline: none; border-color: #e94560; }
        .console-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .console-header h2 { color: #e94560; flex-grow: 1; }
        .loading { text-align: center; padding: 50px; font-size: 20px; color: #aaa; }
        #emulator-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 1000; }
        #emulator-overlay .close-btn { position: fixed; top: 15px; right: 15px; z-index: 1001; background: #e94560; color: #fff; border: none; padding: 15px 30px; cursor: pointer; border-radius: 8px; font-size: 16px; }
        #emulator-container { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        #progress-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center; }
        .progress-content { background: #16213e; padding: 40px; border-radius: 15px; text-align: center; max-width: 500px; width: 90%; }
        .progress-content h3 { color: #e94560; margin-bottom: 20px; }
        .progress-bar { width: 100%; height: 30px; background: #0f3460; border-radius: 15px; overflow: hidden; margin-bottom: 15px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #4ade80, #22c55e); width: 0%; }
        .progress-text { color: #aaa; font-size: 14px; }
        .cancel-btn { margin-top: 20px; background: #e94560; color: #fff; border: none; padding: 10px 30px; border-radius: 8px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="header"><h1>Mis ROMs</h1></div>
    <div class="container">
        <div id="consoles-view" class="consoles"><div class="loading">Cargando consolas...</div></div>
        <div id="games-view" class="games">
            <div class="console-header">
                <button class="back-btn" onclick="showConsoles()">‚Üê Volver</button>
                <h2 id="console-title"></h2>
                <button class="download-all-btn" onclick="downloadAllRoms()">‚¨á Descargar Pack</button>
            </div>
            <input type="text" class="search" id="search-input" placeholder="Buscar juego..." oninput="filterGames(this.value)">
            <div id="games-list" class="games-grid"></div>
        </div>
    </div>
    <div id="emulator-overlay">
        <button class="close-btn" onclick="closeEmulator()">‚úï Cerrar (ESC)</button>
        <div id="emulator-container"></div>
    </div>
    <div id="progress-modal">
        <div class="progress-content">
            <h3 id="progress-title">Preparando descarga...</h3>
            <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
            <p class="progress-text" id="progress-text">Iniciando...</p>
            <button class="cancel-btn" onclick="cancelDownload()">Cancelar</button>
        </div>
    </div>
    <script>
        const CONSOLES = {
            gba: { name: 'Game Boy Advance', core: 'mgba', extensions: ['.gba'], icon: 'üéÆ' },
            gbc: { name: 'Game Boy Color', core: 'gambatte', extensions: ['.gbc', '.gb'], icon: 'üü¢' },
            snes: { name: 'Super Nintendo', core: 'snes9x', extensions: ['.smc', '.sfc'], icon: 'üïπÔ∏è' },
            nds: { name: 'Nintendo DS', core: 'melonds', extensions: ['.nds'], icon: 'üì±' },
            nes: { name: 'Nintendo NES', core: 'fceumm', extensions: ['.nes'], icon: 'üïπÔ∏è' }
        };
        let gamesData = {}, currentConsole = null, allCurrentGames = [], downloadCancelled = false;

        async function loadGames() {
            for (const [folder, info] of Object.entries(CONSOLES)) {
                try {
                    const response = await fetch('/roms/' + folder + '/');
                    if (!response.ok) continue;
                    const html = await response.text();
                    const games = [], regex = /<a href="([^"]+)">/g;
                    let match;
                    while ((match = regex.exec(html)) !== null) {
                        const filename = decodeURIComponent(match[1]);
                        if (info.extensions.some(ext => filename.toLowerCase().endsWith(ext))) {
                            games.push({ name: filename.replace(/\.[^.]+$/, ''), file: filename, folder: folder, core: info.core });
                        }
                    }
                    gamesData[folder] = games.sort((a, b) => a.name.localeCompare(b.name, 'es'));
                } catch (e) { gamesData[folder] = []; }
            }
            renderConsoles();
        }

        function renderConsoles() {
            const container = document.getElementById('consoles-view');
            container.innerHTML = '';
            let hasGames = false;
            for (const [folder, info] of Object.entries(CONSOLES)) {
                const count = gamesData[folder]?.length || 0;
                if (count > 0) {
                    hasGames = true;
                    const btn = document.createElement('div');
                    btn.className = 'console-btn';
                    btn.innerHTML = '<h2>' + info.name + '</h2><span>' + count + ' juegos</span><button class="download-pack" onclick="event.stopPropagation(); downloadConsolePack(\'' + folder + '\')">‚¨á Descargar Pack</button>';
                    btn.onclick = () => showGames(folder);
                    container.appendChild(btn);
                }
            }
            if (!hasGames) container.innerHTML = '<div class="loading">No se encontraron juegos</div>';
        }

        function showGames(folder) {
            currentConsole = folder;
            allCurrentGames = gamesData[folder] || [];
            document.getElementById('console-title').textContent = CONSOLES[folder].name + ' (' + allCurrentGames.length + ' juegos)';
            document.getElementById('consoles-view').style.display = 'none';
            document.getElementById('games-view').classList.add('active');
            document.getElementById('search-input').value = '';
            renderGames(allCurrentGames);
        }

        function renderGames(games) {
            const container = document.getElementById('games-list');
            container.innerHTML = '';
            if (games.length === 0) { container.innerHTML = '<div class="loading">No hay juegos</div>'; return; }
            games.forEach((game, i) => {
                const card = document.createElement('div');
                card.className = 'game-card';
                const icon = CONSOLES[game.folder]?.icon || 'üéÆ';
                const shortName = game.name.length > 30 ? game.name.substring(0, 30) + '...' : game.name;
                card.innerHTML = '<div class="game-cover" onclick="launchGame(gamesData[\'' + game.folder + '\'][' + gamesData[game.folder].indexOf(game) + '])"><div class="no-cover"><div class="icon">' + icon + '</div><div class="name">' + shortName + '</div></div></div><div class="game-info"><div class="game-title" title="' + game.name + '">' + game.name + '</div><div class="game-actions"><button class="btn-play" onclick="launchGame(gamesData[\'' + game.folder + '\'][' + gamesData[game.folder].indexOf(game) + '])">‚ñ∂ Jugar</button><button class="btn-download" onclick="downloadRom(gamesData[\'' + game.folder + '\'][' + gamesData[game.folder].indexOf(game) + '])">‚¨á ROM</button></div></div>';
                container.appendChild(card);
            });
        }

        function filterGames(query) {
            const q = query.toLowerCase().trim();
            renderGames(q ? allCurrentGames.filter(g => g.name.toLowerCase().includes(q)) : allCurrentGames);
        }

        function showConsoles() {
            document.getElementById('consoles-view').style.display = 'grid';
            document.getElementById('games-view').classList.remove('active');
            currentConsole = null;
        }

        function downloadRom(game) {
            const a = document.createElement('a');
            a.href = '/roms/' + game.folder + '/' + encodeURIComponent(game.file);
            a.download = game.file;
            a.click();
        }

        async function downloadConsolePack(folder) { await downloadPack(gamesData[folder], CONSOLES[folder].name); }
        async function downloadAllRoms() { if (currentConsole) await downloadPack(allCurrentGames, CONSOLES[currentConsole].name); }

        async function downloadPack(games, consoleName) {
            if (!games || games.length === 0) return;
            downloadCancelled = false;
            const modal = document.getElementById('progress-modal');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            document.getElementById('progress-title').textContent = 'Descargando ' + consoleName + '...';
            modal.style.display = 'flex';
            progressFill.style.width = '0%';

            const zip = new JSZip();
            let completed = 0;
            for (const game of games) {
                if (downloadCancelled) { modal.style.display = 'none'; return; }
                try {
                    progressText.textContent = 'Descargando: ' + game.name;
                    const response = await fetch('/roms/' + game.folder + '/' + encodeURIComponent(game.file));
                    if (response.ok) zip.file(game.file, await response.blob());
                } catch (e) {}
                completed++;
                progressFill.style.width = Math.round((completed / games.length) * 100) + '%';
            }
            if (downloadCancelled) { modal.style.display = 'none'; return; }
            progressText.textContent = 'Generando ZIP...';
            const content = await zip.generateAsync({ type: 'blob', compression: 'DEFLATE' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(content);
            a.download = consoleName.replace(/\s+/g, '_') + '_ROMs.zip';
            a.click();
            URL.revokeObjectURL(a.href);
            modal.style.display = 'none';
        }

        function cancelDownload() { downloadCancelled = true; }

        function launchGame(game) {
            const container = document.getElementById('emulator-container');
            container.innerHTML = '<div id="game" style="width:900px;height:700px;max-width:95vw;max-height:85vh;"></div>';
            document.getElementById('emulator-overlay').style.display = 'block';
            window.EJS_player = '#game';
            window.EJS_gameUrl = window.location.origin + '/roms/' + game.folder + '/' + encodeURIComponent(game.file);
            window.EJS_core = game.core;
            window.EJS_pathtodata = 'https://cdn.emulatorjs.org/stable/data/';
            window.EJS_startOnLoaded = true;
            const script = document.createElement('script');
            script.src = 'https://cdn.emulatorjs.org/stable/data/loader.js';
            document.body.appendChild(script);
        }

        function closeEmulator() {
            document.getElementById('emulator-overlay').style.display = 'none';
            document.getElementById('emulator-container').innerHTML = '';
            location.reload();
        }

        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeEmulator(); });
        loadGames();
    </script>
</body>
</html>
