services:
  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    ports:
      - "8096:8096"
      - "8920:8920"
    devices:
      - /dev/dri:/dev/dri
    group_add:
      - "44"    # video
      - "109"   # render
    environment:
      - LIBVA_DRIVER_NAME=i965
    volumes:
      - /mnt/Expansion/data/jellyfin:/config
      - /mnt/INTENSO:/mnt/INTENSO:ro
      - /mnt/Expansion:/mnt/Expansion:ro
    restart: unless-stopped

  komga:
    image: gotson/komga:latest
    container_name: komga
    ports:
      - "25600:25600"
    user: "1000:1000"
    environment:
      - JAVA_TOOL_OPTIONS=-Xms128m -Xmx512m -Dspring.main.lazy-initialization=true
    volumes:
      - /home/kroryan/docker-data/komga:/config
      - /mnt/INTENSO:/mnt/INTENSO:ro
      - /mnt/Expansion:/mnt/Expansion:ro
    restart: unless-stopped

  audiobookshelf:
    image: ghcr.io/advplyr/audiobookshelf:latest
    container_name: audiobookshelf
    ports:
      - "13378:80"
    volumes:
      - /home/kroryan/docker-data/audiobookshelf/config:/config
      - /home/kroryan/docker-data/audiobookshelf/metadata:/metadata
      - /mnt/INTENSO/Audible:/audiobooks:ro
    restart: unless-stopped

  calibre-web:
    image: lscr.io/linuxserver/calibre-web:latest
    container_name: calibre-web
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Madrid
    ports:
      - "8083:8083"
    volumes:
      - /home/kroryan/docker-data/calibre-web:/config
      - /mnt/INTENSO:/mnt/INTENSO:ro
      - /mnt/Expansion:/mnt/Expansion:ro
    restart: unless-stopped

  emulador:
    image: nginx:alpine
    container_name: emulador
    ports:
      - "4500:80"
    volumes:
      - /mnt/Expansion/roms:/usr/share/nginx/html/roms:rw  # read-write para subidas
      - /home/kroryan/docker-data/roms-server/thumbnails:/usr/share/nginx/html/thumbnails:rw  # read-write para thumbs
      - /home/kroryan/docker-data/roms-server/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - /home/kroryan/docker-data/roms-server/index.html:/usr/share/nginx/html/index.html:ro
      - /home/kroryan/docker-data/roms-server/.htpasswd:/etc/nginx/.htpasswd:ro
      - /tmp/nginx:/var/cache/nginx  # Temporal de nginx
    command: >
      sh -c "
      mkdir -p /var/cache/nginx/client_temp /var/cache/nginx/proxy_temp /var/cache/nginx/fastcgi_temp /var/cache/nginx/uwsgi_temp /var/cache/nginx/scgi_temp &&
      chmod -R 777 /var/cache/nginx &&
      nginx -g 'daemon off;'
      "
    restart: unless-stopped

  upload-server:
    image: python:3-alpine
    container_name: upload-server
    ports:
      - "8888:8080"
    volumes:
      - /mnt/Expansion/roms:/roms:rw
      - /home/kroryan/docker-data/roms-server/thumbnails:/thumbnails:rw
      - /home/kroryan/docker-data/roms-server/upload_server.py:/app/upload_server.py:ro
    working_dir: /app
    command: ["python3", "upload_server.py"]
    restart: unless-stopped
